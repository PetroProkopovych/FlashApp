<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="authorization">
    <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="email" placeholder="email">
    <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="password" placeholder="password">
    <button style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="button" id="send">Enter</button>
</div>
<div id="add-news" style="display: none">
    <form id="add-news-form" method="post" enctype="multipart/form-data" accept-charset="UTF-8">
        <textarea id="title" placeholder="title" rows="3" maxlength="300" style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box; resize: none"></textarea>
        <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="hashtag1" placeholder="hashtag1">
        <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="hashtag2" placeholder="hashtag2">
        <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="hashtag3" placeholder="hashtag3">
        <input style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="text" id="coordinates" placeholder="">
        <div class="images">
            <input type="file" style="margin-left: 10px; padding: 10px; width: 100%;" id="image-1" accept="image/*">
        </div>
        <input type="submit" style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" value="Add">
        <button style="width: calc(100% - 20px); margin: 10px; padding: 10px; display: block; box-sizing: border-box" type="button" id="coord_butt">Get coordinates</button>
    </form>
</div>

<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
<script>
    $('#send').click(function() {
        $.ajax({
            url: "http://"+$('#url').val()+":8080/login",
            data: ({
                email: $('#email').val(),
                password: $('#password').val()
            }),
            dataType: "json",
            crossDomain: true,
            success: function (data) {
                if (!data.error) {
                    alert('success');
                    $('#authorization').hide();
                    $('#add-news').show();
                }
                else {
                    $('#password').val("");
                    alert('Неверный логин или пароль');
                }
            },
            error: function (xhr) {
                alert('Ошибка сервера');
                alert(xhr.status);
                alert(xhr.responseText);
            }
        });
    });
    $('#add-news-form').submit(function(e) {
        e.preventDefault();
        var data = new FormData();
        data.append('title', $('#title').val());
        $(this).find('input').each(function() {
            if ($(this).attr('type') != 'submit' && $(this).attr('type') != 'file' && $(this).val() != '') {
                data.append($(this).attr('id'), $(this).val());
            }
        });
        $(this).find('.images input').each(function() {
            var fileControl = document.getElementById($(this).attr('id'));
            if(fileControl.files.length > 0) {
                data.append($(this).attr('id'), fileControl.files[0]);
            }
        });
        for (var key of data.keys()) {
            console.log(key + ' - ' + data.get(key));
        }
        var boundary=Math.random().toString().substr(2);
        $.ajax({
            type: "POST",
            url: "http://"+$('#url').val()+":8080/addNews",
            data: data,
            processData: false,
            contentType: false,
            success: function (data) {
                if (!data.error) {
                    console.log(data);
                    alert('success');
                }
                else {
                    alert('error');
                }
            },
            error: function (xhr) {
                alert('Ошибка сервера');
                alert(xhr.status);
                alert(xhr.responseText);
            }
        });
    });
    $('.images').on('change', 'input', function() {
        if($(this).is(':last-child') && $('.images input').length < 8) {
            $('.images').append('<input type="file" style="margin-left: 10px; padding: 10px; width: 100%;" id="image-' + (+$(this).attr('id').split('-')[1] + 1) + '" accept="image/*">');
        }
    });

    function onSuccess(position) {
        alert('success');
        $('#coordinates').val(position.coords.latitude + ";" + position.coords.longitude);
        /*alert('Latitude: '          + position.coords.latitude          + '\n' +
         'Longitude: '         + position.coords.longitude         + '\n' +
         'Altitude: '          + position.coords.altitude          + '\n' +
         'Accuracy: '          + position.coords.accuracy          + '\n' +
         'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
         'Heading: '           + position.coords.heading           + '\n' +
         'Speed: '             + position.coords.speed             + '\n' +
         'Timestamp: '         + position.timestamp                + '\n');*/
    };

    function onError(error) {
        alert('Coordinates error: code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
    }

    $('#coord_butt').click(function() {
        var options = {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000
        }
        navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
    });
</script>
</body>
</html>